name: Release

on:
  push:
    branches: [main]
    paths: ['first_breaks/VERSION']


permissions:
  contents: write


jobs:
  autotag:
    name: Create tag if VERSION changed
    runs-on: ubuntu-24.04
    permissions:
      contents: write   # needed for pushing tags
    outputs:
      tagcreated: ${{ steps.set.outputs.tagcreated }}
      tagname: ${{ steps.set.outputs.tagname }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # we need full tag history

      - id: read
        run: |
          ver="$(tr -d '[:space:]' < first_breaks/VERSION)"
          echo "ver=$ver" >> "$GITHUB_OUTPUT"

      - id: set
        if: ${{ github.event_name == 'push' }}
        env:
          VER: ${{ steps.read.outputs.ver }}
        run: |
          git fetch --tags
          if git rev-parse "v$VER" >/dev/null 2>&1; then
            echo "tagcreated=no" >> "$GITHUB_OUTPUT"
            echo "tagname=v$VER"  >> "$GITHUB_OUTPUT"
          else
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "v$VER" -m "Release v$VER"
            git push origin "v$VER"
            echo "tagcreated=yes" >> "$GITHUB_OUTPUT"
            echo "tagname=v$VER"  >> "$GITHUB_OUTPUT"
          fi

  publish_assets:
    name: Build and publish assets
    needs: autotag
    if: ${{ needs.autotag.outputs.tagcreated == 'yes' }}
    runs-on: windows-latest
    strategy:
      matrix:
        type: ['CPU']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check versions
        shell: bash
        run: |
          pip install tomli
          python checks.py

      - name: Setup for ${{ matrix.type }} Build
        shell: pwsh
        env:
          BUILD_TYPE: ${{ matrix.type }}
        run: |
          if ($env:BUILD_TYPE -eq 'GPU') {
            Move-Item -Path .\pyproject_gpu.toml -Destination .\pyproject.toml -Force
          }

      - name: ${{ matrix.type }} - Install Wheels
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools wheel build twine
          python -m build --sdist --wheel

      - name: ${{ matrix.type }} - Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PY_PI_TOKEN }}
        shell: bash
        run: twine upload dist/*

      - name: ${{ matrix.type }} - Install Builder
        run: |
          python -m pip install briefcase
          # Install WiX v5 CLI (required by recent Briefcase)
          dotnet tool install --global wix --version 5.*
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: ${{ matrix.type }} - Create Package
        shell: pwsh
        run: |
          Remove-Item -Path .\build -Recurse -Force
          briefcase create

      - name: ${{ matrix.type }} - Build Package
        shell: pwsh
        run: briefcase build

      - name: ${{ matrix.type }} - Create Installer MSI
        shell: pwsh
        run: |
          briefcase package --adhoc-sign --packaging-format msi
          Remove-Item -Path .\dist\*.wixpdb -Force
      - name: ${{ matrix.type }} - Create Installer ZIP
        shell: pwsh
        run: briefcase package --adhoc-sign --packaging-format zip

      - name: ${{ matrix.type }} - Upload assets to GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.autotag.outputs.tagname }}
          file_glob: true
          file: dist/*
          overwrite: true
