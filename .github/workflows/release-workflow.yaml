name: Release

on:
  push:
#    branches: [main]
    paths: ['first_breaks/VERSION']


permissions:
  contents: write


jobs:
  autotag:
    name: Create tag if VERSION changed
    runs-on: ubuntu-24.04
    permissions:
      contents: write   # needed for pushing tags
    outputs:
      tagcreated: ${{ steps.set.outputs.tagcreated }}
      tagname: ${{ steps.set.outputs.tagname }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # we need full tag history

      - id: read
        run: |
          ver="$(tr -d '[:space:]' < first_breaks/VERSION)"
          echo "ver=$ver" >> "$GITHUB_OUTPUT"

      - id: set
        if: ${{ github.event_name == 'push' }}
        env:
          VER: ${{ steps.read.outputs.ver }}
        run: |
          git fetch --tags
          if git rev-parse "v$VER" >/dev/null 2>&1; then
            echo "tagcreated=no" >> "$GITHUB_OUTPUT"
            echo "tagname=v$VER"  >> "$GITHUB_OUTPUT"
          else
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "v$VER" -m "Release v$VER"
            git push origin "v$VER"
            echo "tagcreated=yes" >> "$GITHUB_OUTPUT"
            echo "tagname=v$VER"  >> "$GITHUB_OUTPUT"
          fi

  publish_wheels:
      name: Publish PyPI
      needs: autotag
      if: ${{ needs.autotag.outputs.tagcreated == 'yes' }}
      runs-on: ubuntu-24.04
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: "3.12"

        - name: Install Wheels
          shell: bash
          run: |
            python -m pip install --upgrade pip
            python -m pip install --upgrade setuptools wheel build twine
            python -m build --sdist --wheel

        - name: Upload to PyPI
          env:
            TWINE_USERNAME: __token__
            TWINE_PASSWORD: ${{ secrets.PY_PI_TOKEN }}
          shell: bash
          run: twine upload dist/*

        - name: Upload to GitHub Release
          uses: svenstaro/upload-release-action@v2
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            tag: ${{ needs.autotag.outputs.tagname }}
            file_glob: true
            file: dist/*
            overwrite: true


  publish_assets:
    name: Build and publish assets
    needs: autotag
    if: ${{ needs.autotag.outputs.tagcreated == 'yes' }}
    runs-on: windows-latest
    strategy:
      matrix:
        flavor: [ cpu, cuda, openvino ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Briefcase & WiX 5
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install "briefcase==0.3.25"
          dotnet tool install --global wix --version 5.*
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Map flavor â†’ app name
        id: map
        shell: pwsh
        run: |
          $app = switch ("${{ matrix.flavor }}") {
            "cpu"      { "fbcpu" }
            "cuda"     { "fbcuda" }
            "openvino" { "fbopenvino" }
          }
          echo "APP=$app" >> $env:GITHUB_OUTPUT

      - name: Create
        shell: pwsh
        run: briefcase create windows --app ${{ steps.map.outputs.APP }}

      - name: Build
        shell: pwsh
        run: briefcase build windows --app ${{ steps.map.outputs.APP }} -r

      - name: Package ZIP
        shell: pwsh
        run: briefcase package windows --app ${{ steps.map.outputs.APP }} --adhoc-sign --packaging-format zip


      - name: Upload assets to GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.autotag.outputs.tagname }}
          file_glob: true
          file: dist/*
          overwrite: true
